{% extends 'teacher/teacherbase.html' %}
{% block content %}
{% load static %}
{% load bootcamp_filters %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance</title>
    <!-- Include Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <script>
        // Function to gather data from the table and submit via POST request
        function captureTableData() {
            // Get the table rows
            var table = document.getElementById('attendance-table');
            var rows = table.getElementsByTagName('tr');
            var formData = new FormData(document.getElementById('attendance-form'));

            // Loop through table rows (starting from index 1 to skip header row)
            for (var i = 1; i < rows.length; i++) {
                var cells = rows[i].getElementsByTagName('td');
                var student_id = cells[0].innerText.trim();  // Get student ID from first column
                var attendance = cells[4].getElementsByTagName('input')[0].checked ? 1 : 0;  // Attendance value

                // Add the attendance data for each student to the form data
                formData.append('attendance_' + student_id, attendance);
            }

            // Submit the form with the table data
            var request = new XMLHttpRequest();
            request.open("POST", document.getElementById('attendance-form').action, true);
            request.setRequestHeader("X-Requested-With", "XMLHttpRequest");

            request.onload = function() {
                if (request.status === 200) {
                    alert("Attendance data saved successfully!");
                    // Optionally redirect or update the page
                }
            };

            // Send the form data via AJAX
            request.send(formData);
        }
    </script>
</head>

<div class="card students-list">
    <div class="card-header border-0 flex-wrap pb-0">
        <h4>Student List for Attendance</h4>

        <!-- Search Form -->
        <form method="GET" action="{% url 'student-attendance' %}" class="form-inline">
            <div class="input-group">
                <select name="grade_id" class="form-control">
                    <option value="">All Grades</option>
                    {% for grade in grades %}
                        <option value="{{ grade.id }}" {% if grade.id|stringformat:"s" == selected_grade %}selected{% endif %}>{{ grade.grade_name }}</option>
                    {% endfor %}
                </select>

                <select name="division_id" class="form-control">
                    <option value="">All Divisions</option>
                    {% for division in divisions %}
                        <option value="{{ division.id }}" {% if division.id|stringformat:"s" == selected_division %}selected{% endif %}>{{ division.division_name }}</option>
                    {% endfor %}
                </select>

                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </form>
    </div>

    <!-- Attendance Form -->
    <form method="POST" action="{% url 'student-attendance' %}" id="attendance-form">
        {% csrf_token %}
        <!-- Date Picker -->
        <input type="text" class="form-control" name="tdate" id="tdate" placeholder="Select Date"
        value="{{ tdate }}">

        <div class="table-responsive">
            <table id="attendance-table" class="table display mb-4">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Grade</th>
                        <th>Division</th>
                        <th>Attendance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>{{ student.id }}</td>
                        <td>{{ student.first_name }} {{ student.last_name }}</td>
                        <td>{{ student.grade.grade_name }}</td>
                        <td>{{ student.division.division_name }}</td>
                        <td>
                            <input type="checkbox" name="attendance_{{ student.id }}" 
                                   {% if student.id in present_students %} checked {% endif %}>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <button type="button" class="btn btn-primary" onclick="captureTableData()">Save</button>
    </form>
</div>
<!-- Include Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    // Initialize Flatpickr for the date input with format dd-mm-yyyy
    flatpickr("#tdate", {
        dateFormat: "d-m-Y", // Format date as dd-mm-yyyy
        allowInput: false, // Disable text input, only allow date selection
        defaultDate: "today", // Default to today's date
        locale: {
            firstDayOfWeek: 1 // Start the calendar on Monday (optional)
        }
    });
</script>
<script>
    $(document).ready(function() {
        // Initialize the datepicker
        $('#tdate').datepicker({
            format: 'dd-mm-yyyy',  // Ensure this matches the date format you're using
            autoclose: true,
            todayHighlight: true
        });
    });
</script>
{% endblock content %}
